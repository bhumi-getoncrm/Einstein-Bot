<!DOCTYPE html>
<html>
<head>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jsforce/1.9.1/jsforce.min.js"></script>
  <script>
    jsforce.browser.init({
      loginUrl: 'https://login.salesforce.com',
      //clientId: '3MVG9pRzvMkjMb6kBymhP55a2BB7TMIMw3St73GYnnGWpIdYp7Z7_ay21rUJXnu2.hEyb0IKOgaEnQ4dNQW8k',
      clientId: '3MVG98_Psg5cppyYCmk1gZNC25o00SXpgpodlS29IZ6pXiHkt3xuPa5qIjBTtEgdsiMuIWVN_8F0jnwEtbDh4'
      redirectUri: 'https://bhumigothi.github.io/Einstein-Bot/FileExtract.html'
    });
     jsforce.browser.on('connect', function(conn) {
        fetchDoc(conn);
     });
    async function fetchDoc(conn){
        //const res = await conn.query("SELECT Id, Name, Body, ParentId, ContentType from Attachment where ParentId IN( SELECT Id FROM account where name like '%b2b%')");
      const res = await conn.query("SELECT Id, Name, Body, ParentId, ContentType from Attachment where ParentId IN (SELECT ID from CASE where Queue_Name_WR__c  = 'WayfairCC' OR Owner.Name = 'Automated Process' OR (Status like 'Closed%' AND CreatedDate < LAST_YEAR))");
          //res.records.forEach(record => {
          for (const record of res.records) {
            const response = await conn
            .sobject('Attachment')
            .retrieve(record.Id);
            //.catch(handleConnectionError);

            // we use fetch instead of jsforce.Connection.retrieve because jsforce
            // can return a garbled string when downloading images
            const fetchResponse = await fetch(`${conn.instanceUrl}/${response.Body}`, {
              headers: { Authorization: `Bearer ${conn.accessToken}` },
            });

            const blob = await fetchResponse.blob();

            var a = document.createElement("a");
            document.body.appendChild(a);
            a.style = "display: none";
            url = window.URL.createObjectURL(blob);
              a.href = url;
              a.download = record.ParentId + '_' + record.Name;
              a.click();
              window.URL.revokeObjectURL(url);
      }
    
  }
  </script>
</head>
<body>
  <button onclick="javascript:jsforce.browser.login();">Login</button>
</body>
</html>
